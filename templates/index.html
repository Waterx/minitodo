<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>自在Todo</title>
    <!-- Compiled and minified CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Compiled and minified JavaScript -->

    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        .todo_cell {
            margin: 10px;
            /* background-color: lightblue; */
        }

        main {
            max-width: 85%;
            margin: auto;
            position: relative;
            left: 200px;
            padding: 40px 0 30px 0;
        }

        .todo_container {
            display: inline-block;
        }

        .hide {
            display: none;
        }

        .progress {
            position: fixed;
        }

        .sidenav {
            max-width: 270px;
        }
    </style>
</head>

<body>
    <div class="progress hide jindutiao">
        <div class="indeterminate"></div>
    </div>

    <ul class="sidenav sidenav-fixed">
        <li>
            <div class="user-view">
                <div class="background">
                    <img src="static/images/moutain.jpg">
                </div>
                <a href="#user"><img class="circle" src="static/images/cat.jpg"></a>
                <a href="#name"><span class="white-text name">John Doe</span></a>
                <a href="#email"><span class="white-text email">jdandturk@gmail.com</span></a>
            </div>
        </li>
        <li><a href="#!" class='waves-effect'><i class="material-icons">done_all</i>任务<span class="new badge red"
                    data-badge-caption="todo">4</span></a></li>
        <li><a href="#!" class='waves-effect'><i class="material-icons">folder</i>项目</a></li>
        <li><a href="#!" class='waves-effect'><i class="material-icons">bookmark</i>标签</a></li>
        <li><a href="#!" class='waves-effect'><i class="material-icons">receipt</i>便签</a></li>


        <li>
            <div class="divider"></div>
        </li>
        <li><a class="subheader">Subheader</a></li>
        <li><a class="subheader">Subheader</a></li>

        <li><a class="subheader">Subheader</a></li>

        <li><a class="subheader">Subheader</a></li>

        <li class='margin-bottom'><a class="waves-effect" href="#!">Third Link With Waves</a></li>
    </ul>

    <!-- 弹出来的详细编辑页 -->
    <div id="modal1" class="modal">
        <div class="modal-content">
            <h4>Modal Header</h4>
            <p>A bunch of text</p>
        </div>
        <div class="modal-footer">
            <a href="#!" class="modal-close waves-effect waves-green btn-flat">Agree</a>
        </div>
    </div>



    <main>

        <h2>TODO</h2>
        <a class="waves-effect waves-light btn modal-trigger" href="#modal1">Modal</a>



        <div class="row">
            <form class="col s12" action=/add method="post">
                <div class="row">
                    <div class="input-field col s6">
                        <input id="input_text" type="text" data-length="15" name='title' maxlength="15" class=pink-text>
                        <label for="input_text">输入待办事项</label>
                    </div>
                </div>
            </form>
        </div>


        <div class="todo_container">
            <!-- <div class="todo_cell row item card-panel hoverable" data-id="4705">
                <span>
                    <label>
                        <input class="checkbox" type="checkbox" />
                        <span class="todo_title">**TEST演示 This is a todo cell</span>
                    </label>
                </span>

                <span class="edit-btns right">
                    <a class="right button delete-btn">
                        <i class="material-icons small-icon left clearbtn">clear</i>
                    </a>
                    <a class="right button edit-btn">
                        <i class="material-icons small-icon left editbtn">mode_edit</i>
                    </a>
                    <a class="right button reorder-btn">
                        <i class="material-icons small-icon left reorderbtn">reorder</i>
                    </a>
                </span>
            </div> -->
        </div>
        <div class="todo_container">
            <!-- <div class="todo_cell row item card-panel hoverable" data-id="4705">
                <span>
                    <label>
                        <input class="checkbox" type="checkbox" />
                        <span class="todo_title">**TEST演示 This is a todo cell</span>
                    </label>
                </span>

                <span class="edit-btns right">
                    <a class="right button delete-btn">
                        <i class="material-icons small-icon left clearbtn">clear</i>
                    </a>
                    <a class="right button edit-btn">
                        <i class="material-icons small-icon left editbtn">mode_edit</i>
                    </a>
                    <a class="right button reorder-btn">
                        <i class="material-icons small-icon left reorderbtn">reorder</i>
                    </a>
                </span>
            </div> -->
        </div>
    </main>


    <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

    <script>
        M.AutoInit();
        $(document).ready(function () {
            $('.sidenav').sidenav();
            $('input#input_text, textarea#textarea1').characterCounter();

        });


    </script>
    <script>
        // 自己的 ajax 轮子

        var ajax = function (method, path, headers, data, reseponseCallback) {
            var r = new XMLHttpRequest()
            // 设置请求方法和请求地址
            r.open(method, path, true)
            // 设置发送的数据的格式
            r.setRequestHeader('Content-Type', 'application/json')
            // r.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded')
            // 注册响应函数
            r.onreadystatechange = function () {
                if (r.readyState === 4) {
                    reseponseCallback(r)
                }
                // if (r.readyState === 4) {
                //     console.log('state change', r, r.status, r.response)
                //     var response = JSON.parse(r.response)
                //     console.log('response', response)
                // } else {
                //     console.log('change')
                // }
            }
            // 发送请求
            r.send(data)
        }
        // 等待函数
        function sleep(delay) {
            var start = (new Date()).getTime();
            while ((new Date()).getTime() - start < delay) {
                continue;
            }
        }
        // 刷新网页时遍历插入 todocell 的函数
        let inserTodos = function (todos) {
            for (let i in todos) {
                console.log(i, ':', todos[i])
                let checked = ''
                if (todos[i].done === true) {
                    flag = true
                    checked = 'checked='
                }
                $('.todo_container').append(
                    `
                    <div class="todo_cell row item card-panel hoverable" data-id="${todos[i].todo_id}">
                    <span>
                    <label>
                        <input class="checkbox" type="checkbox" ${checked}/>
                        <span class="todo_title">${todos[i].title}</span>
                    </label>
                    </span>

                    <span class="edit-btns right">

                    <a herf='#!' class="right delete-btn">
                        <i class="material-icons small-icon left clearbtn">clear</i>
                    </a>
                    <a herf='#!' class="right edit-btn">
                        <i class="material-icons small-icon left editbtn">mode_edit</i>
                    </a>
                    <a href='#modal1' class="right reorder-btn modal-trigger">
                        <i class="material-icons small-icon left reorderbtn">reorder</i>
                    </a>

                    </span>

                    </div>
                    `
                    //<i class="material-icons small-icon left reorderbtn">reorder</i>
                )


            }
        }
        let todos = undefined
        ajax('GET', '/all', null, '', function (r) {
            todos = JSON.parse(r.response)
            console.log(typeof (todos))
            inserTodos(todos)
            //console.log(r.status, r.response)
        })

    </script>
    <script>
        // 这个 script 的用途为改变 done 的状态， 然后传给服务器
        // $('.todo_cell').click(function (event) {
        //     console.log('clicked')
        // })
        $('.todo_container').click(function (event) {
            $('.progress').removeClass('hide')

            target = event.target
            todo_id = $(target).parents("div").attr('data-id');

            // 当按到checkbox
            if (target.classList.contains('todo_title')) {
                console.log('checkbox clicked', todo_id)
                var data = {
                    'todo_id': todo_id,
                }
                data = JSON.stringify(data)
                ajax('POST', '/check', null, data, function (r) {
                    check = JSON.parse(r.response)
                    console.log(check)
                    // setTimeout($('.progress').addClass('hide'), 1000000)
                    $('.progress').addClass('hide')

                })
            }

            // 当按到删除按钮
            else if (target.classList.contains('clearbtn')) {
                console.log('ckick del', todo_id)
                var data = {
                    'todo_id': todo_id,
                }
                data = JSON.stringify(data)
                ajax('POST', '/delete', null, data, function (r) {
                    check = JSON.parse(r.response)
                    console.log('delete', check)
                    if (check === 1) {
                        t = `[data-id='${todo_id}']`
                        console.log(t)
                        $(t).remove()
                        $('.progress').addClass('hide')

                    }
                })
            }

            else if (target.classList.contains('editxbtn')) {

            }

            // 当按到编辑按钮
            else if (target.classList.contains('editbtn')) {
                console.log('edit', todo_id)
                t = `[data-id='${todo_id}']`
                // empty删除选中元素的子元素
                t = $(t).empty()
                console.log(t)
                input = `
                    <input type="text" name="change_title" class="pink-text">
                `
                t = $(t).append(input)
                $(t).keyup(function (e) {
                    var key = e.which;
                    if (key == 13) {
                        // title is a string type
                        let title = $(t).children("input").val()
                        console.log('!!title', title)
                        console.log('!!enter')
                        var data = {
                            'todo_id': todo_id,
                            'title': title,
                        }
                        data = JSON.stringify(data)
                        ajax('POST', '/edit', null, data, function (r) {
                            eid = JSON.parse(r.response)
                            console.log(eid)
                            $(t).empty()
                            cell = `
                            <span>
                            <label>
                            <input class="checkbox" type="checkbox"/>
                            <span class="todo_title">${title}</span>
                            </label>
                            </span>

                            <span class="edit-btns right">
                            <a herf='#!' class="right  delete-btn">
                            <i class="material-icons small-icon left clearbtn">clear</i>
                            </a>
                            <a herf='#!' class="right  edit-btn">
                            <i class="material-icons small-icon left editbtn">mode_edit</i>
                            </a>
                            <a href='#modal1' class="right  reorder-btn modal-trigger">
                            <i class="material-icons small-icon left reorderbtn">reorder</i>
                            </a>
                            </span>
                            
                            `
                            $(t).append(cell)
                            $('.progress').addClass('hide')

                        })


                    }
                })


            }



        })


    </script>
</body>

</html>